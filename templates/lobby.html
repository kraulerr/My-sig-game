<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–õ–æ–±–±–∏ –∏–≥—Ä—ã</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        body { background: #1a1a2e; color: white; font-family: sans-serif; text-align: center; }
        .container { width: 80%; margin: 0 auto; }
        .player-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin-top: 30px; }
        .player-card { background: #16213e; padding: 15px; border-radius: 10px; width: 150px; text-align: center; border: 2px solid #0f3460; }
        .player-card img { width: 80px; height: 80px; border-radius: 50%; margin-bottom: 10px; }
        .player-name { font-weight: bold; font-size: 1.2em; color: #e94560; }
        .player-score { color: #ccc; }
    </style>
</head>
<body>
    <div class="container">
        <h1>–ö–æ–º–Ω–∞—Ç–∞ –æ–∂–∏–¥–∞–Ω–∏—è</h1>
        
        <!-- –¢–∞–π–º–µ—Ä –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á–µ—Ç–∞ (—Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
        <div id="countdown-box" style="display:none; color: #e94560; font-size: 24px; margin-bottom: 20px;">
            –ò–≥—Ä–∞ –Ω–∞—á–Ω–µ—Ç—Å—è —á–µ—Ä–µ–∑: <span id="timer">10</span> —Å–µ–∫.
        </div>

        <div id="players-container" class="player-grid"></div>

        <div class="controls" style="margin-top: 40px;">
            <!-- –ö–Ω–æ–ø–∫–∞ "–Ø –ì–æ—Ço–≤" (–¥–ª—è –≤—Å–µ—Ö) -->
            <button id="btn-ready" onclick="toggleReady()" style="background: #444; color: white; padding: 15px 30px; font-size: 18px; border: none; cursor: pointer; border-radius: 5px; margin-right: 10px;">
                –Ø –ì–û–¢–û–í ‚úÖ
            </button>

            <!-- –ü–∞–Ω–µ–ª—å –ê–¥–º–∏–Ω–∞ (—Å–∫—Ä—ã—Ç–∞, –ø–æ–∫–∞–∂–µ—Ç JS –µ—Å–ª–∏ —Ç—ã –∞–¥–º–∏–Ω) -->
            <div id="admin-panel" style="display:none; margin-top: 20px; border-top: 1px solid #444; padding-top: 20px;">
                <h3 style="color: #e94560;">–ü–∞–Ω–µ–ª—å –í–µ–¥—É—â–µ–≥–æ</h3>
                <button onclick="forceStart()" style="background: #e94560; color: white; padding: 10px 20px; border: none; cursor: pointer; border-radius: 5px;">
                    –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–´–ô –°–¢–ê–†–¢ üöÄ
                </button>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let mySocketId = null; // –ß—Ç–æ–±—ã –∑–Ω–∞—Ç—å, –∫—Ç–æ –Ø
        let countdownInterval = null;

        // ... (—Ç—É—Ç –∫–æ–¥ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫–∞–∫ —Ä–∞–Ω—å—à–µ) ...
        const myName = localStorage.getItem('my_name');
        const myAvatar = localStorage.getItem('my_avatar');
        if (!myName || !myAvatar) window.location.href = "/";
        else socket.emit('join_request', { name: myName, avatar: myAvatar });


        socket.on('update_player_list', function(players) {
            const container = document.getElementById('players-container');
            const adminPanel = document.getElementById('admin-panel');
            const btnReady = document.getElementById('btn-ready');
            container.innerHTML = '';
            
            // –ù–∞—Ö–æ–¥–∏–º –º–æ–π ID (–ø–æ –∏–º–µ–Ω–∏, –≥—Ä—É–±–æ, –Ω–æ –¥–ª—è –ø—Ä–æ—Ç–æ—Ç–∏–ø–∞ —Å–æ–π–¥–µ—Ç)
            // –í –∏–¥–µ–∞–ª–µ —Å–µ—Ä–≤–µ—Ä –¥–æ–ª–∂–µ–Ω –ø—Ä–∏—Å—ã–ª–∞—Ç—å "—Ç–≤–æ–π ID", –Ω–æ SocketIO —ç—Ç–æ –¥–µ–ª–∞–µ—Ç —Ö–∏—Ç—Ä–æ.
            // –ü–æ–∫–∞ –±—É–¥–µ–º –æ—Ç—Ä–∏—Å–æ–≤—ã–≤–∞—Ç—å –≤—Å–µ—Ö.
            
            // –ü—Ä–æ–±–µ–≥–∞–µ–º—Å—è –ø–æ –∏–≥—Ä–æ–∫–∞–º, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –°–ï–ë–Ø –∏ –ø–æ–Ω—è—Ç—å, –ê–¥–º–∏–Ω –ª–∏ —è
            // –í–Ω–∏–º–∞–Ω–∏–µ: socket.id –º–µ–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏, –ø–æ—ç—Ç–æ–º—É –Ω–∞–¥–µ–∂–Ω–µ–µ
            // –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ —Ñ–ª–∞–≥ is_admin –≤–Ω—É—Ç—Ä–∏ –æ–±—ä–µ–∫—Ç–∞ –∏–≥—Ä–æ–∫–∞, 
            // –Ω–æ –º—ã –ø–æ–∫–∞ –Ω–µ –∑–Ω–∞–µ–º, –∫–∞–∫–æ–π –∏–∑ –æ–±—ä–µ–∫—Ç–æ–≤ –≤ players - —ç—Ç–æ –ú–´.
            // –£–ø—Ä–æ—â–µ–Ω–∏–µ: —Å–µ—Ä–≤–µ—Ä –ø—Ä–∏—Å—ã–ª–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å –ø–æ ID —Å–æ–∫–µ—Ç–æ–≤.
            
            // –•–∏—Ç—Ä–æ—Å—Ç—å: –º—ã –º–æ–∂–µ–º –ø–æ–ø—Ä–æ—Å–∏—Ç—å —Å–µ—Ä–≤–µ—Ä —Å–∫–∞–∑–∞—Ç—å –Ω–∞–º –Ω–∞—à ID –æ—Ç–¥–µ–ª—å–Ω–æ,
            // –Ω–æ –ø–æ–∫–∞ —Å–¥–µ–ª–∞–µ–º –æ—Ç—Ä–∏—Å–æ–≤–∫—É "–≤ –ª–æ–±".
            
            // –†–∏—Å—É–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏
            for (let id in players) {
                let p = players[id];
                let isMe = (p.name === myName); // –ü—Ä–æ–≤–µ—Ä–∫–∞ "–≠—Ç–æ —è?"
                
                // –ï—Å–ª–∏ —è –ê–¥–º–∏–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
                if (isMe && p.is_admin) {
                    adminPanel.style.display = 'block';
                }

                // –°—Ç–∞—Ç—É—Å –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ (–ó–µ–ª–µ–Ω–∞—è —Ä–∞–º–∫–∞ –∏–ª–∏ —Å–µ—Ä–∞—è)
                let borderStyle = p.is_ready ? "4px solid #4CAF50" : "2px solid #0f3460";
                let statusIcon = p.is_ready ? "‚úÖ" : "‚è≥";
                
                // –ö–Ω–æ–ø–∫–∞ –∫–∏–∫–∞ (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ–º, –µ—Å–ª–∏ –¢–´ –∞–¥–º–∏–Ω, –Ω–æ –Ω–µ –Ω–∞ —Å–µ–±–µ)
                // –î–ª—è —ç—Ç–æ–≥–æ –Ω–∞–º –Ω–∞–¥–æ —Ç–æ—á–Ω–æ –∑–Ω–∞—Ç—å, —á—Ç–æ –Ø - –∞–¥–º–∏–Ω.
                // –î–∞–≤–∞–π—Ç–µ —É–ø—Ä–æ—Å—Ç–∏–º: –∫–Ω–æ–ø–∫—É –∫–∏–∫–∞ —Ä–∏—Å—É–µ–º, –Ω–æ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç –æ–Ω–∞ —Ç–æ–ª—å–∫–æ —É –∞–¥–º–∏–Ω–∞.
                // –ê –ª—É—á—à–µ: –¥–æ–±–∞–≤–∏–º –≤ CSS –∫–ª–∞—Å—Å .kick-btn –∏ –ø–æ–∫–∞–∂–µ–º –µ–≥–æ JS-–æ–º.
                
                let kickButton = '';
                // (–≠—Ç–æ —Ö–∞–∫: –º—ã –ø–æ–∫–∞–∂–µ–º –∫–Ω–æ–ø–∫—É –≤—Å–µ–º, –Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –æ–Ω–∞ –±—É–¥–µ—Ç —Ç–æ–ª—å–∫–æ —É –∞–¥–º–∏–Ω–∞, 
                // —Å–µ—Ä–≤–µ—Ä –ø—Ä–æ–≤–µ—Ä–∏—Ç. –í –∏–¥–µ–∞–ª–µ —Å–∫—Ä—ã–≤–∞—Ç—å CSS-–æ–º).
                if (!isMe) { 
                    kickButton = `<button onclick="kickPlayer('${id}')" style="background:red; color:white; border:none; border-radius:50%; width:25px; height:25px; position:absolute; top:-10px; right:-10px; cursor:pointer;">X</button>`;
                }

                let card = `
                    <div class="player-card" style="border: ${borderStyle}; position: relative;">
                        ${kickButton}
                        <img src="/static/images/avatars/${p.avatar}">
                        <div class="player-name">${p.name} ${p.is_admin ? "üëë" : ""}</div>
                        <div class="player-status">${statusIcon}</div>
                    </div>
                `;
                container.innerHTML += card;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –°–í–û–ï–ô –∫–Ω–æ–ø–∫–∏
                if (isMe) {
                    btnReady.innerText = p.is_ready ? "–ù–ï –ì–û–¢–û–í ‚ùå" : "–Ø –ì–û–¢–û–í ‚úÖ";
                    btnReady.style.background = p.is_ready ? "#555" : "#4CAF50";
                }
            }
        });

        // --- –§–£–ù–ö–¶–ò–ò ---
        function toggleReady() {
            socket.emit('toggle_ready');
        }
        
        function forceStart() {
            if(confirm("–ó–∞–ø—É—Å—Ç–∏—Ç—å –∏–≥—Ä—É –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ?")) {
                socket.emit('force_start');
            }
        }
        
        function kickPlayer(id) {
            if(confirm("–í—ã–≥–Ω–∞—Ç—å —ç—Ç–æ–≥–æ –∏–≥—Ä–æ–∫–∞?")) {
                socket.emit('kick_player', {target_id: id});
            }
        }

        // --- –¢–ê–ô–ú–ï–†–´ ---
        socket.on('start_timer_signal', function(data) {
            document.getElementById('countdown-box').style.display = 'block';
            let sec = data.seconds;
            document.getElementById('timer').innerText = sec;
            
            if (countdownInterval) clearInterval(countdownInterval);
            
            countdownInterval = setInterval(() => {
                sec--;
                document.getElementById('timer').innerText = sec;
                if (sec <= 0) {
                    clearInterval(countdownInterval);
                }
            }, 1000);
        });

        socket.on('stop_timer_signal', function() {
            document.getElementById('countdown-box').style.display = 'none';
            if (countdownInterval) clearInterval(countdownInterval);
        });
        
        socket.on('redirect_to_game', function(data) {
             window.location.href = data.url;
        });
    </script>
</body>
</html>
